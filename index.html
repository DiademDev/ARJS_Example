<!DOCTYPE html>
<html>
    <head>
        <title>GLTF Import and Animation</title>
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    </head>
    <body>
        <a-scene embedded arjs shadow="type: pcfsoft">
            <a-marker preset="hiro" id="marker">

                <!-- Import GLTF model -->
                <a-entity 
                    gltf-model="Dying.glb"
                    id="gltfEntity"
                    position="0 0.1 0"
                    shadow="cast: true"
                    scale="0.75 0.75 0.75">
                </a-entity>

                <a-entity light="type: directional; color: #fdfbe2; intensity: 3.0; castShadow: true;" 
                shadowCameraLeft="-4" 
                shadowCameraRight="4" 
                shadowCameraTop="4" 
                shadowCameraBottom="-4" 
                shadowMapWidth="2048" 
                shadowMapHeight="2048"
                position="20 40 50"></a-entity>
                
                <a-light type="hemisphere" color="#508bb4" groundColor="#506548" intensity="1.0"></a-light>
                
                <!-- Ground plane and shadow catcher -->
                <a-circle id="ground" radius="2" position="0 0.1 0" rotation="-90 0 0" material="src: tiling.jpg; repeat: 10 10; side: double; roughness: 1.0;"></a-circle>
                <a-circle id="groundShadow" radius="2" color="#130704" position="0 0.1 0" rotation="-90 0 0" material="transparent: true; opacity: 0.8" shadow="receive: true"></a-circle>

                <!-- Animate text -->
                <a-text id="text" value="Hello World!" position="-10 1.5 -0.5" color="white" width="6" opacity="0" font="https://cdn.aframe.io/fonts/Exo2Bold.fnt" 
                animation__slide="property: position; to: -1.0 1.5 -0.5; dur: 5000; easing: easeOutCubic"
                animation__fade="property: opacity; to: 1; dur: 5000; delay: 500; easing: easeOutCubic"></a-text>

            </a-marker>
            <a-camera position="0 .1 3"></a-camera>
        </a-scene>

        <script>
            const gltfEntity = document.getElementById('gltfEntity');
            const marker = document.getElementById('marker');

            let mixer; // Animation mixer
            let clock = new THREE.Clock();

            // Handle GLTF loaded event to initialize animations
            gltfEntity.addEventListener('model-loaded', (event) => {
                const gltf = event.detail.model; // Get the loaded GLTF scene
                console.log('GLTF Loaded:', gltf);

                // Check if animations exist
                if (gltf.animations && gltf.animations.length > 0) {
                    const model = gltfEntity.getObject3D('mesh'); // Access the 3D model
                    mixer = new THREE.AnimationMixer(model);

                    // Play the first animation
                    const action = mixer.clipAction(gltf.animations[0]);
                    action.play();
                } else {
                    console.warn('No animations found in the GLTF model.');
                }
            });

            // Start/stop animations based on marker detection
            marker.addEventListener('markerFound', () => {
                console.log('Marker detected!');
                if (mixer) {
                    mixer.timeScale = 1; // Resume animation
                }
            });

            marker.addEventListener('markerLost', () => {
                console.log('Marker lost!');
                if (mixer) {
                    mixer.timeScale = 0; // Pause animation
                }
            });

            // Update the animation mixer in the A-Frame render loop
            AFRAME.registerComponent('animate-gltf', {
                tick: function () {
                    if (mixer) {
                        const delta = clock.getDelta();
                        mixer.update(delta);
                    }
                },
            });

            // Attach the animation update component to the scene
            document.querySelector('a-scene').setAttribute('animate-gltf', '');
        </script>
    </body>
</html>
