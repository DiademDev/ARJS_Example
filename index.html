<!DOCTYPE html>
<html>
    <head>
        <title>GLTF Import and Animation</title>
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    </head>
    <body>
        <a-scene embedded arjs shadow="type: pcfsoft">
            <a-marker preset="hiro" id="marker">
                <!-- Import GLTF model -->
                <a-entity 
                    gltf-model="Dying.glb"
                    id="gltfEntity"
                    position="0 0.1 0"
                    shadow="cast:"
                    scale="1 1 1">
                </a-entity>

                <a-entity light="type: directional; color: #fdfbe2; intensity: 3.0; castShadow: true;" 
                shadowCameraLeft="-5" 
                shadowCameraRight="5" 
                shadowCameraTop="5" 
                shadowCameraBottom="-5" 
                shadowMapWidth="2048" 
                shadowMapHeight="2048"
                position="20 40 50"></a-entity>
                <a-entity light="type: hemisphere; color: #508bb4; groundColor: #506548; intensity: 2.0"></a-entity>
                <a-circle id="ground" radius="5" position="0 0.1 0" rotation="-90 0 0" material="src: tiling.jpg; repeat: 20 20; side: double; roughness: 1.0;"></a-circle>
                <a-circle id="ground" radius="5" color="#2f0f06" position="0 0.1 0" rotation="-90 0 0" material="transparent: true; opacity: 0.8" shadow="receive: true"></a-circle>

            </a-marker>
            <a-entity camera></a-entity>
        </a-scene>

        <script>
            const gltfEntity = document.getElementById('gltfEntity');
            const marker = document.getElementById('marker');

            let mixer; // Animation mixer
            let clock = new THREE.Clock();

            // Handle GLTF loaded event to initialize animations
            gltfEntity.addEventListener('model-loaded', (event) => {
                const gltf = event.detail.model; // Get the loaded GLTF scene
                console.log('GLTF Loaded:', gltf);

                // Check if animations exist
                if (gltf.animations && gltf.animations.length > 0) {
                    const model = gltfEntity.getObject3D('mesh'); // Access the 3D model
                    mixer = new THREE.AnimationMixer(model);

                    // Play the first animation
                    const action = mixer.clipAction(gltf.animations[0]);
                    action.play();
                } else {
                    console.warn('No animations found in the GLTF model.');
                }
            });

            // Start/stop animations based on marker detection
            marker.addEventListener('markerFound', () => {
                console.log('Marker detected!');
                if (mixer) {
                    mixer.timeScale = 1; // Resume animation
                }
            });

            marker.addEventListener('markerLost', () => {
                console.log('Marker lost!');
                if (mixer) {
                    mixer.timeScale = 0; // Pause animation
                }
            });

            // Update the animation mixer in the A-Frame render loop
            AFRAME.registerComponent('animate-gltf', {
                tick: function () {
                    if (mixer) {
                        const delta = clock.getDelta();
                        mixer.update(delta);
                    }
                },
            });

            // Attach the animation update component to the scene
            document.querySelector('a-scene').setAttribute('animate-gltf', '');
        </script>
    </body>
</html>
